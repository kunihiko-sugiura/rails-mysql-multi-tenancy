# rails-mysql-multi-tenancy
Rails + Mysql + Multi tenancy  

注)内容更新中  

MysqlでのSingle SchemaによるMulti Tenancy実装を検討する。  
前提として以下を考慮する。  
- RailsとMysqlを利用
- Apartment gemを利用したMulti schema実装からの移行

## Apartment gem(Schema分割方式)を利用したMulti tenancy
### メリット
- 物理的にTenant事にschemaが分離しているため、神経質にDBデータにアクセスせずとも他テナントのデータを誤って参照してしまう可能性を下げられる
- 上記によりテストなどの考慮事項が減る
  例えばAPIで認証・認可などの共通処理を通した際に、 自動的に該当企業へ切り替える仕組みを作っておけば、APIなどの機能実装時に暗黙的にテナント切り替えされている仕組み構築可能
  本来テストコードにて担保するべきだが逐一リクエストテスト、結合テスト等でパターンを作るのもコストが高い。

### 問題点
- Apartment gemの問題
  - Apartmentのバージョンアップの問題
    - Railsのバージョンアップを行いたくても、Apartmentの対応待ちになる
    - 脆弱性対応があるマイナーバージョン更新でも問題が発生する事がある
    - 将来的にApartmentのメンテナンス状態に不安がある
- Railsに関する問題
  - ActiveRecord(ORM)が実行するデータマッピング用の情報取得のクエリの実行時間が増大する
    - スキーマ、テーブルが多いと影響が出る（アプリケーションへの実害があるかは不明）
- DBの問題
  - メモリ使用率の上昇
    - 【追記必要】
    - スキーマ、テーブルの数が多い事が起因となり、Cloud上でのDBのバックアップ、dumpが失敗したり、時間が極端にかかるなどありえる
- 運用の問題
  - 複数環境へのデプロイが発生することによる問題
    - リリースが部分的に失敗する可能性が上がる
    - インフラのメンテナンスが各環境で発生することによるメンテナンスコストが上がる
- サーバー構成上の問題
  - 外部サービスからpushリクエストを受ける必要がある際には、一旦特定のエンドポイントでリクエストを集約して受けつけ、どのアプリケーションサーバにリクエストを投げるか判定を行う必要が発生する場合がある
- インフラコストの問題
  - 長期的にみて解約テナントが増えた場合に1環境内の稼働テナントが減る

## 検討内容
上記の問題点を解決しつつメリットを受けるには以下の構造へ移行する必要がある。
- Row level securityの導入に関して
  - そもそも導入する必要があるか
  - Mysqlにてに相当する仕組みの検討
- Multi schemaのデータをSingle schemaへ統合する
  - 主としてidの重複、データのunique制約の問題

### 他のDBへ移行するかの検討
OracleとPostgreSqlではRow level securityが存在するが、 Mysqlには存在しない。
そのため他のDBへ移行を検討するが、解決したい内容に対してあまりにも影響が大きすぎると考えている。
本来テストコードにて防ぐ事が可能ではあり保険的な取り組みだと認識している。

RLSがない場合の懸念点
- 参照しようとしているテナント以外のテナントのデータが参照できてしまう
- 作成対象のデータに対して別テナントのテーブルのデータの関連を作成できてしまう

### idの一意性に関しての検討
- テナントで利用するテーブルにtenant_idを追加する
- Primary keyをテーブルのid + tenant_idとする
- Apartment gemがv3に上がったことによりRails7に対応したため、Rails 7.1までバージョンアップする
  (7.1では複合Primary keyが対応)

### テナント毎に連番が必要なテーブルに対する対応
そもそも、テーブルのidを連番として利用するのは、以下の理由にて担保できない。
- Mysql5.7まではサーバー再起動時にauto_incrementのcurrent_idが戻ってしまう問題があった
- Data migration serviceによるデータ移行でauto_incrementのidが歯抜けとなる可能性がある(PostgreSqlでは発生した)

連番が必要な場合は、id以外のカラムで管理する手法がある。
採番テーブルを作成しストアドプロシージャやfunctionなどを利用して採番ロジックを実装する方法もあり。
(行ロックなどのロジックをアプリケーションで実装するよりDB側で管理した方が安定するのではないかと考えている)

### MysqlにてRow level securityに相当する仕組み
注)内容更新中

- テーブル事に更新可能なビューを作成する  
https://dev.mysql.com/doc/refman/8.0/ja/view-check-option.html

- modelの参照するテーブルを任意に更新可能Viewを指定する

### idの採番の検討
- idに関しては既存の形式から変更しない方が良いと考えている
- もし数値型のidの場合、別のid形式(uuidなど)への切り替えをした方がidの一意性は担保しやすいが、切り替えのためのコストが非常に高い
- Storageのfile pathや外部システム連携にテーブルのidをそのまま利用していた場合に、id変更は移行コストが非常に高い

## 大枠の案
- id採番の手法に問わず既存のid発行の型、手法は変更しない
- id, tenant_idで複合Primary keyに変更する
- auto incrementの値を任意に設定すれば、id重複のエラーを回避できる

## 移行計画
- どの単位で移行するか
- tenant_idを各テーブルに追加し、データ投入

